name: Daily System Report (Build & Push Docker)

permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: "0 03 * * *"   # 03:00 UTC daily — edit to your desired time
  workflow_dispatch:

concurrency:
  group: daily-report
  cancel-in-progress: false

jobs:
  # Build image (independent job)
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image (local tag)
        run: docker build -t daily-report:ci .

      - name: Save image to file (optional - speeds debugging)
        run: docker image inspect daily-report:ci || true

      - name: Upload docker build artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-metadata
          path: |
            $(pwd)/  # optional, keep lightweight

  # Push to Docker Hub (depends on build)
  push-docker:
    needs: docker-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      - name: Build Docker image for push
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-daily-report:latest .

      - name: Tag image with timestamp
        run: |
          TAG=$(date +'%Y%m%d-%H%M%S')
          docker tag ${{ secrets.DOCKER_USERNAME }}/devops-daily-report:latest \
                     ${{ secrets.DOCKER_USERNAME }}/devops-daily-report:$TAG
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      - name: Push images (with retry)
        run: |
          n=0
          until [ $n -ge 3 ]
          do
            docker push ${{ secrets.DOCKER_USERNAME }}/devops-daily-report:latest && \
            docker push ${{ secrets.DOCKER_USERNAME }}/devops-daily-report:${{ env.IMAGE_TAG }} && break
            n=$((n+1))
            echo "Retry #$n in 5s..."
            sleep 5
          done

  # Run report and commit reports (depends on push)
  run-and-commit:
    needs: push-docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Make report script executable
        run: chmod +x script/daily_report.sh

      - name: Run report script
        run: bash script/daily_report.sh

      - name: Commit and push reports (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/ || true
          git commit -m "Daily report: $(date +'%Y-%m-%d')" || echo "No changes to commit"
          # push with retry to avoid transient errors
          n=0
          until [ $n -ge 3 ]
          do
            git push origin main && break
            n=$((n+1))
            echo "Push retry #$n"
            sleep 5
          done

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: system-report
          path: reports/*.txt

      - name: Notify Slack (if configured)
        if: always()
        run: |
          STATUS="Success ✅"
          if [ "${{ job.status }}" != "success" ]; then STATUS="Failed ❌"; fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"DevOps Report — $STATUS\nRepo: ${{ github.repository }}\nRun: ${{ github.run_id }}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}