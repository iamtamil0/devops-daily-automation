name: Daily System Report (Build & Push Docker)

on:
  schedule:
    - cron: "30 3 * * *"   # 9:00 AM IST daily
  workflow_dispatch:
  push:
    paths:
      - "script/**"
      - "docker/Dockerfile"

jobs:

  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------
      # DOCKER LOGIN
      # ------------------------------
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | \
          docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ------------------------------
      # BUILD IMAGE
      # ------------------------------
      - name: Build Docker image
        run: |
          docker build -t daily-report:latest -f docker/Dockerfile .

      # ------------------------------
      # TAG IMAGE
      # ------------------------------
      - name: Tag Docker images
        run: |
          TAG=$(date +'%Y%m%d%H%M')
          echo "TAG=$TAG" >> $GITHUB_ENV
          docker tag daily-report:latest ${{ secrets.DOCKER_USERNAME }}/daily-report:latest
          docker tag daily-report:latest ${{ secrets.DOCKER_USERNAME }}/daily-report:$TAG

      # ------------------------------
      # PUSH IMAGES
      # ------------------------------
      - name: Push Docker images
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/daily-report:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/daily-report:${TAG}

      # ------------------------------
      # CREATE ISSUE IF ERROR FOUND
      # ------------------------------
      - name: Create GitHub Issue on Failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "System Error Detected in Daily Report"
          content-filepath: ./reports/latest_report.txt
          labels: error, automated

      # ------------------------------
      # SEND EMAIL (optional)
      # ------------------------------
      - name: Send Report Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.example.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Daily System Report"
          to: "ntamilmanin@gmail.com"
          from: "GitHub Actions Bot"
          attachments: ./reports/latest_report.txt

  run-and-commit:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------
      # RUN CONTAINER
      # ------------------------------
      - name: Run report generator container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app/output \
            ${{ secrets.DOCKER_USERNAME }}/daily-report:latest

      # ------------------------------
      # COMMIT REPORT
      # ------------------------------
      - name: Commit daily report
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Auto update: Daily system report $(date)" || echo "No changes to commit"
          git push
